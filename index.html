<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>筆算電卓</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <!-- Icon: 軽量なSVGアイコンを使用 -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB4PSI4MCIgeT0iNDgiIHdpZHRoPSIzNTIiIGhlaWdodD0iNDE2IiByeD0iNDgiIHJ5PSI0OCIgZmlsbD0iIzMzMyIvPjxyZWN0IHg9IjExMiIgeT0iODAiIHdpZHRoPSIyODgiIGhlaWdodD0iOTYiIHJ4PSIxNiIgcnk9IjE2IiBmaWxsPSIjYmNmN2JjIi8+PGNpcmNsZSBjeD0iMTYwIiBjeT0iMjQwIiByPSIyNCIgZmlsbD0iIzY2NiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI0MCIgcj0iMjQiIGZpbGw9IiM2NjYiLz48Y2lyY2xlIGN4PSIzNTIiIGN5PSIyNDAiIHI9IjI0IiBmaWxsPSIjZmY5NTAwIi8+PGNpcmNsZSBjeD0iMTYwIiBjeT0iMzIwIiByPSIyNCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjMyMCIgcj0iMjQiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIzNTIiIGN5PSIzMjAiIHI9IjI0IiBmaWxsPSIjZmY5NTAwIi8+PGNpcmNsZSBjeD0iMTYwIiBjeT0iNDAwIiByPSIyNCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjQwMCIgcj0iMjQiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIzNTIiIGN5PSI0MDAiIHI9IjI0IiBmaWxsPSIjZmY5NTAwIi8+PC9zdmc+">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB4PSI4MCIgeT0iNDgiIHdpZHRoPSIzNTIiIGhlaWdodD0iNDE2IiByeD0iNDgiIHJ5PSI0OCIgZmlsbD0iIzMzMyIvPjxyZWN0IHg9IjExMiIgeT0iODAiIHdpZHRoPSIyODgiIGhlaWdodD0iOTYiIHJ4PSIxNiIgcnk9IjE2IiBmaWxsPSIjYmNmN2JjIi8+PGNpcmNsZSBjeD0iMTYwIiBjeT0iMjQwIiByPSIyNCIgZmlsbD0iIzY2NiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI0MCIgcj0iMjQiIGZpbGw9IiM2NjYiLz48Y2lyY2xlIGN4PSIzNTIiIGN5PSIyNDAiIHI9IjI0IiBmaWxsPSIjZmY5NTAwIi8+PGNpcmNsZSBjeD0iMTYwIiBjeT0iMzIwIiByPSIyNCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjMyMCIgcj0iMjQiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIzNTIiIGN5PSIzMjAiIHI9IjI0IiBmaWxsPSIjZmY5NTAwIi8+PGNpcmNsZSBjeD0iMTYwIiBjeT0iNDAwIiByPSIyNCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjQwMCIgcj0iMjQiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIzNTIiIGN5PSI0MDAiIHI9IjI0IiBmaWxsPSIjZmY5NTAwIi8+PC9zdmc+">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600&display=swap');
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0f172a;
        margin: 0; padding: 0;
        overflow: hidden;
        overscroll-behavior: none;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        display: flex;
        align-items: center;
        justify-content: center;
        /* 画面いっぱいの高さを確保 */
        height: 100dvh;
      }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
      
      /* スクロールバー装飾 */
      .custom-scroll::-webkit-scrollbar { width: 4px; }
      .custom-scroll::-webkit-scrollbar-track { background: transparent; }
      .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
    </style>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root" class="w-full h-full flex items-center justify-center"></div>

    <script type="text/babel">
        // --- COMPONENTS ---

        const Button = ({ label, onClick, className = '', variant = 'default' }) => {
            const baseStyles = "active:scale-95 transition-transform duration-75 select-none text-xl md:text-2xl font-medium rounded-lg shadow-sm flex items-center justify-center w-full h-full";
            
            const variants = {
                default: "bg-white text-slate-700 hover:bg-slate-50 border border-slate-200", 
                operator: "bg-blue-100 text-blue-700 hover:bg-blue-200 border border-blue-200", 
                action: "bg-slate-200 text-slate-800 hover:bg-slate-300 border border-slate-300", 
                accent: "bg-blue-600 text-white hover:bg-blue-700 border border-blue-700 shadow-md", 
            };

            return (
                <button
                    onClick={onClick}
                    className={`${baseStyles} ${variants[variant]} ${className}`}
                    type="button"
                >
                    {label}
                </button>
            );
        };

        const Tape = ({ entries, onToggleEntry }) => {
            const bottomRef = React.useRef(null);

            React.useEffect(() => {
                if (entries.length > 0 && bottomRef.current) {
                    bottomRef.current.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, [entries]);

            const formatNumber = (num) => {
                return new Intl.NumberFormat('ja-JP', { maximumFractionDigits: 10 }).format(num);
            };

            const getDisplayOperator = (op) => {
                switch(op) {
                    case '*': return '×';
                    case '/': return '÷';
                    case '+': return '+';
                    case '-': return '-';
                    case '=': return '=';
                    default: return '';
                }
            };

            return (
                <div className="flex-1 min-h-0 overflow-y-auto p-1 scroll-smooth custom-scroll font-mono text-slate-800">
                    {entries.length === 0 && (
                        <div className="h-full flex flex-col items-center justify-center text-slate-300 space-y-2 select-none">
                             <div className="w-8 h-1 bg-slate-200 rounded-full mb-1"></div>
                             <p className="text-[10px]">No entries</p>
                        </div>
                    )}

                    <div className="flex flex-col gap-0.5">
                        {entries.map((entry) => {
                            if (entry.isTotal) {
                               return (
                                  <div key={entry.id} className="flex flex-col pt-1 pb-2 mb-1">
                                      <div className="border-t-2 border-slate-400 mb-0.5 mx-1"></div>
                                      <div className="flex justify-end items-center px-1 font-bold text-slate-900">
                                          <span className="text-base tracking-tight">{formatNumber(entry.value)}</span>
                                      </div>
                                      <div className="border-b border-dashed border-slate-300 mt-1 mx-2"></div>
                                  </div>
                               );
                            }

                            return (
                              <div
                                key={entry.id}
                                onClick={() => onToggleEntry(entry.id)}
                                className={`
                                  relative flex items-center justify-between px-1 py-1 cursor-pointer select-none rounded hover:bg-slate-100 transition-colors
                                  ${entry.isExcluded ? 'opacity-50 line-through decoration-red-500/50 decoration-2 bg-red-50' : ''}
                                `}
                              >
                                 <div className="text-slate-500 font-bold text-xs w-4 text-center shrink-0 mt-0.5">
                                    {getDisplayOperator(entry.operator)}
                                 </div>
                                 <div className="text-sm font-medium text-slate-700 text-right flex-1 leading-tight tracking-tight whitespace-nowrap overflow-hidden text-ellipsis">
                                    {formatNumber(entry.value)}
                                 </div>
                              </div>
                            );
                        })}
                        <div ref={bottomRef} />
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentInput, setCurrentInput] = React.useState('0');
            const [tape, setTape] = React.useState(() => {
                try {
                    const saved = window.localStorage.getItem('calculator_tape');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });
            const [pendingOperator, setPendingOperator] = React.useState(null);
            const [grandTotal, setGrandTotal] = React.useState(() => {
                try {
                    const saved = window.localStorage.getItem('calculator_grand_total');
                    return saved ? parseFloat(saved) : 0;
                } catch (e) { return 0; }
            });
            const [isNewNumber, setIsNewNumber] = React.useState(true);

            React.useEffect(() => {
                try { window.localStorage.setItem('calculator_tape', JSON.stringify(tape)); } catch(e){}
            }, [tape]);

            React.useEffect(() => {
                try { window.localStorage.setItem('calculator_grand_total', grandTotal.toString()); } catch(e){}
            }, [grandTotal]);

            const calculateTapeTotal = React.useCallback((entries) => {
                if (entries.length === 0) return 0;
                let startIndex = 0;
                for (let i = entries.length - 1; i >= 0; i--) {
                    if (entries[i].isTotal) {
                        startIndex = i + 1;
                        break;
                    }
                }
                let total = 0;
                let hasStarted = false;
                for (let i = startIndex; i < entries.length; i++) {
                    const entry = entries[i];
                    if (entry.isExcluded || entry.isTotal) continue;
                    const val = entry.value;
                    const op = entry.operator;
                    if (!hasStarted || op === undefined) {
                        total = val;
                        hasStarted = true;
                    } else {
                         switch (op) {
                            case '+': total += val; break;
                            case '-': total -= val; break;
                            case '*': total *= val; break;
                            case '/': if (val !== 0) total /= val; break;
                         }
                    }
                }
                return total;
            }, []);

            const currentSolution = React.useMemo(() => {
                if (tape.length === 0) return 0;
                const lastEntry = tape[tape.length - 1];
                if (lastEntry.isTotal) {
                    return lastEntry.value;
                }
                return calculateTapeTotal(tape);
            }, [tape, calculateTapeTotal]);

            const handleNumber = (num) => {
                if (isNewNumber) {
                    setCurrentInput(num);
                    setIsNewNumber(false);
                } else {
                    if (num === '.' && currentInput.includes('.')) return;
                    if (num === '0' && currentInput === '0') return;
                    if (num === '00' && currentInput === '0') return;
                    setCurrentInput(prev => (prev === '0' && num !== '.') ? num : prev + num);
                }
            };

            const handleOperator = (op) => {
                const val = parseFloat(currentInput);
                const lastEntryIsTotal = tape.length > 0 && tape[tape.length - 1].isTotal;
                if (op === '=') {
                    if (tape.length === 0 && !pendingOperator) return;
                    let entryOp = pendingOperator || '+';
                    if (
