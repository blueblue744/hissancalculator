<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>筆算電卓</title>
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0f172a">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600&display=swap');
      
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0f172a; /* 背景色 */
        margin: 0; padding: 0;
        overflow: hidden;
        overscroll-behavior: none;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        /* 中央揃え用 */
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100dvh; /* ダイナミックビューポート */
      }
      .font-mono { font-family: 'JetBrains Mono', monospace; }
    </style>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root" class="w-full h-full flex items-center justify-center"></div>

    <script type="text/babel">
        // --- COMPONENTS ---

        const Button = ({ label, onClick, className = '', variant = 'default' }) => {
            // 【修正】高さを h-full にして、グリッドのセルいっぱいに広げる
            const baseStyles = "active:scale-95 transition-transform duration-75 select-none text-xl md:text-2xl font-medium rounded-lg shadow-sm flex items-center justify-center w-full h-full";
            
            const variants = {
                default: "bg-white text-slate-700 hover:bg-slate-50 border border-slate-200", 
                operator: "bg-blue-100 text-blue-700 hover:bg-blue-200 border border-blue-200", 
                action: "bg-slate-200 text-slate-800 hover:bg-slate-300 border border-slate-300", 
                accent: "bg-blue-600 text-white hover:bg-blue-700 border border-blue-700 shadow-md", 
            };

            return (
                <button
                    onClick={onClick}
                    className={`${baseStyles} ${variants[variant]} ${className}`}
                    type="button"
                >
                    {label}
                </button>
            );
        };

        const Tape = ({ entries, onToggleEntry }) => {
            const bottomRef = React.useRef(null);

            React.useEffect(() => {
                if (entries.length > 0 && bottomRef.current) {
                    bottomRef.current.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }, [entries]);

            const formatNumber = (num) => {
                return new Intl.NumberFormat('ja-JP', { maximumFractionDigits: 10 }).format(num);
            };

            const getDisplayOperator = (op) => {
                switch(op) {
                    case '*': return '×';
                    case '/': return '÷';
                    case '+': return '+';
                    case '-': return '-';
                    case '=': return '=';
                    default: return '';
                }
            };

            return (
                <div className="flex flex-col h-full font-mono text-slate-800">
                    {/* 中身（スクロール領域） */}
                    <div className="flex-1 overflow-y-auto p-1 scroll-smooth">
                        {entries.length === 0 && (
                            <div className="h-full flex flex-col items-center justify-center text-slate-300 space-y-2 select-none">
                                 <div className="w-8 h-1 bg-slate-200 rounded-full mb-1"></div>
                                 <p className="text-[10px]">No entries</p>
                            </div>
                        )}

                        <div className="flex flex-col gap-0.5 min-h-0">
                            {entries.map((entry) => {
                                if (entry.isTotal) {
                                   return (
                                      <div key={entry.id} className="flex flex-col pt-1 pb-2 mb-1">
                                          <div className="border-t-2 border-slate-400 mb-0.5 mx-1"></div>
                                          <div className="flex justify-end items-center px-1 font-bold text-slate-900">
                                              <span className="text-base tracking-tight">{formatNumber(entry.value)}</span>
                                          </div>
                                          <div className="border-b border-dashed border-slate-300 mt-1 mx-2"></div>
                                      </div>
                                   );
                                }

                                return (
                                  <div
                                    key={entry.id}
                                    onClick={() => onToggleEntry(entry.id)}
                                    className={`
                                      relative flex items-center justify-between px-1 py-1 cursor-pointer select-none rounded hover:bg-slate-100 transition-colors
                                      ${entry.isExcluded ? 'opacity-50 line-through decoration-red-500/50 decoration-2 bg-red-50' : ''}
                                    `}
                                  >
                                     <div className="text-slate-500 font-bold text-xs w-4 text-center shrink-0 mt-0.5">
                                        {getDisplayOperator(entry.operator)}
                                     </div>
                                     <div className="text-sm font-medium text-slate-700 text-right flex-1 leading-tight tracking-tight whitespace-nowrap overflow-hidden text-ellipsis">
                                        {formatNumber(entry.value)}
                                     </div>
                                  </div>
                                );
                            })}
                            <div ref={bottomRef} />
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [currentInput, setCurrentInput] = React.useState('0');
            const [tape, setTape] = React.useState(() => {
                try {
                    const saved = window.localStorage.getItem('calculator_tape');
                    return saved ? JSON.parse(saved) : [];
                } catch (e) { return []; }
            });
            const [pendingOperator, setPendingOperator] = React.useState(null);
            const [grandTotal, setGrandTotal] = React.useState(() => {
                try {
                    const saved = window.localStorage.getItem('calculator_grand_total');
                    return saved ? parseFloat(saved) : 0;
                } catch (e) { return 0; }
            });
            const [isNewNumber, setIsNewNumber] = React.useState(true);

            React.useEffect(() => {
                try { window.localStorage.setItem('calculator_tape', JSON.stringify(tape)); } catch(e){}
            }, [tape]);

            React.useEffect(() => {
                try { window.localStorage.setItem('calculator_grand_total', grandTotal.toString()); } catch(e){}
            }, [grandTotal]);

            const calculateTapeTotal = React.useCallback((entries) => {
                if (entries.length === 0) return 0;
                let startIndex = 0;
                for (let i = entries.length - 1; i >= 0; i--) {
                    if (entries[i].isTotal) {
                        startIndex = i + 1;
                        break;
                    }
                }
                let total = 0;
                let hasStarted = false;
                for (let i = startIndex; i < entries.length; i++) {
                    const entry = entries[i];
                    if (entry.isExcluded || entry.isTotal) continue;
                    const val = entry.value;
                    const op = entry.operator;
                    if (!hasStarted || op === undefined) {
                        total = val;
                        hasStarted = true;
                    } else {
                         switch (op) {
                            case '+': total += val; break;
                            case '-': total -= val; break;
                            case '*': total *= val; break;
                            case '/': if (val !== 0) total /= val; break;
                         }
                    }
                }
                return total;
            }, []);

            const currentSolution = React.useMemo(() => {
                if (tape.length === 0) return 0;
                const lastEntry = tape[tape.length - 1];
                if (lastEntry.isTotal) {
                    return lastEntry.value;
                }
                return calculateTapeTotal(tape);
            }, [tape, calculateTapeTotal]);

            const handleNumber = (num) => {
                if (isNewNumber) {
                    setCurrentInput(num);
                    setIsNewNumber(false);
                } else {
                    if (num === '.' && currentInput.includes('.')) return;
                    if (num === '0' && currentInput === '0') return;
                    if (num === '00' && currentInput === '0') return;
                    setCurrentInput(prev => (prev === '0' && num !== '.') ? num : prev + num);
                }
            };

            const handleOperator = (op) => {
                const val = parseFloat(currentInput);
                const lastEntryIsTotal = tape.length > 0 && tape[tape.length - 1].isTotal;
                if (op === '=') {
                    if (tape.length === 0 && !pendingOperator) return;
                    let entryOp = pendingOperator || '+';
                    if (!pendingOperator && (tape.length === 0 || lastEntryIsTotal)) {
                        entryOp = undefined;
                    }
                    const newEntry = {
                        id: Date.now().toString(),
                        value: val,
                        operator: entryOp,
                        isExcluded: false,
                    };
                    const tempTape = [...tape, newEntry];
                    const result = calculateTapeTotal(tempTape);
                    setGrandTotal(prev => prev + result);
                    const totalEntry = {
                        id: (Date.now() + 1).toString(),
                        value: result,
                        operator: '=',
                        isExcluded: false,
                        isTotal: true
                    };
                    setTape([...tempTape, totalEntry]);
                    setCurrentInput(result.toString());
                    setPendingOperator(null);
                    setIsNewNumber(true);
                } else {
                    if (pendingOperator && isNewNumber && !lastEntryIsTotal && tape.length > 0) {
                         setPendingOperator(op);
                         return;
                    }
                    let newTape = [...tape];
                    if (tape.length === 0 || lastEntryIsTotal) {
                        newTape.push({
                            id: Date.now().toString(),
                            value: val,
                            operator: undefined, 
                            isExcluded: false,
                        });
                    } else {
                        newTape.push({
                            id: Date.now().toString(),
                            value: val,
                            operator: pendingOperator || '+',
                            isExcluded: false,
                        });
                    }
                    setTape(newTape);
                    setPendingOperator(op);
                    const intermediateResult = calculateTapeTotal(newTape);
                    setCurrentInput(intermediateResult.toString());
                    setIsNewNumber(true);
                }
            };

            const handleAction = (action) => {
                switch (action) {
                    case 'AC':
                        setTape([]);
                        setCurrentInput('0');
                        setPendingOperator(null);
                        setGrandTotal(0);
                        setIsNewNumber(true);
                        try {
                            window.localStorage.removeItem('calculator_tape');
                            window.localStorage.removeItem('calculator_grand_total');
                        } catch(e){}
                        break;
                    case 'C':
                        setCurrentInput('0');
                        setIsNewNumber(true);
                        break;
                    case '⌫':
                        if (isNewNumber) return;
                        setCurrentInput(prev => prev.length > 1 ? prev.slice(0, -1) : '0');
                        break;
                    case 'GT':
                         setCurrentInput(grandTotal.toString());
                         setIsNewNumber(true);
                         break;
                }
            };

            const handleToggleEntry = (id) => {
                setTape(prev => prev.map(entry => 
                    entry.id === id && !entry.isTotal ? { ...entry, isExcluded: !entry.isExcluded } : entry
                ));
            };

            const formatDisplay = (numStr) => {
                if (numStr.endsWith('.')) {
                    return parseInt(numStr.slice(0, -1)).toLocaleString('ja-JP') + '.';
                }
                const num = parseFloat(numStr);
                return isNaN(num) ? '0' : num.toLocaleString('ja-JP', { maximumFractionDigits: 10 });
            };

            const formatCurrency = (num) => {
                return num.toLocaleString('ja-JP', { maximumFractionDigits: 10 });
            }

            return (
                // --- メインコンテナ ---
                // 画面全体の高さ(95dvh)を持つカードを作成し、その中に左右の要素を閉じ込める
                <div className="flex w-[98%] md:max-w-4xl h-[95dvh] bg-slate-900 rounded-3xl overflow-hidden shadow-2xl border border-slate-800">
                  
                  {/* LEFT (75%): Calculator */}
                  <div className="w-[75%] flex flex-col p-4 gap-4 h-full">
                    
                    {/* Display Area */}
                    <div className="bg-[#c4cfbe] rounded-xl p-4 shadow-inner border-4 border-slate-700/50 flex flex-col justify-between h-[25%] shrink-0">
                        <div className="flex justify-between items-start">
                            <div className="text-slate-600 text-xs font-bold tracking-wider">
                               {tape.length > 0 && tape[tape.length-1].isTotal ? 'GT' : pendingOperator ? `OP: ${pendingOperator}` : 'READY'}
                            </div>
                            {grandTotal !== 0 && (
                                <div className="text-slate-800 font-bold text-xs bg-slate-600/10 px-1 rounded">GT</div>
                            )}
                        </div>
                        <div className="text-right text-5xl md:text-6xl font-mono font-bold text-slate-800 tracking-tight overflow-hidden text-ellipsis leading-none">
                            {formatDisplay(currentInput)}
                        </div>
                    </div>

                    {/* Keypad Area: flex-1 で残りの高さを全て使う */}
                    <div className="flex-1 grid grid-cols-4 gap-2 md:gap-3">
                        <Button label="AC" onClick={() => handleAction('AC')} variant="accent" className="bg-red-500 hover:bg-red-600 border-red-600 text-white" />
                        <Button label="GT" onClick={() => handleAction('GT')} variant="action" />
                        <Button label="→" onClick={() => handleAction('⌫')} variant="action" />
                        <Button label="÷" onClick={() => handleOperator('/')} variant="operator" />

                        <Button label="7" onClick={() => handleNumber('7')} />
                        <Button label="8" onClick={() => handleNumber('8')} />
                        <Button label="9" onClick={() => handleNumber('9')} />
                        <Button label="×" onClick={() => handleOperator('*')} variant="operator" />

                        <Button label="4" onClick={() => handleNumber('4')} />
                        <Button label="5" onClick={() => handleNumber('5')} />
                        <Button label="6" onClick={() => handleNumber('6')} />
                        <Button label="-" onClick={() => handleOperator('-')} variant="operator" />

                        <Button label="1" onClick={() => handleNumber('1')} />
                        <Button label="2" onClick={() => handleNumber('2')} />
                        <Button label="3" onClick={() => handleNumber('3')} />
                        <Button label="+" onClick={() => handleOperator('+')} variant="operator" />

                        <Button label="0" onClick={() => handleNumber('0')} />
                        <Button label="00" onClick={() => handleNumber('00')} />
                        <Button label="." onClick={() => handleNumber('.')} />
                        <Button label="=" onClick={() => handleOperator('=')} variant="accent" className="bg-blue-600 border-blue-700 text-white"/>
                    </div>
                  </div>

                  {/* RIGHT (25%): Tape */}
                  <div className="w-[25%] flex flex-col bg-[#fffdf5] border-l border-slate-800 h-full">
                      
                      {/* Header (Top Aligned) */}
                      <div className="p-2 bg-slate-200 border-b border-slate-300 text-center text-[10px] font-bold text-slate-500 uppercase tracking-widest shrink-0">
                          History
                      </div>

                      {/* Scrollable Content */}
                      <Tape entries={tape} onToggleEntry={handleToggleEntry} />

                      {/* Footer (Bottom Aligned) */}
                      <div className="bg-slate-50 p-2 flex flex-col justify-center items-end border-t border-slate-200 shadow-[inset_0_2px_4px_rgba(0,0,0,0.05)] shrink-0 h-[15%]">
                         <div className="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">
                             Total
                         </div>
                         <div className="text-xl md:text-2xl font-mono font-bold text-slate-800 break-all leading-none tracking-tight">
                             {formatCurrency(currentSolution)}
                         </div>
                      </div>
                  </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
